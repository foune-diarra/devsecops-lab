name: Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  TRIVY_VERSION: "0.19.0"
  DOCKER_IMAGE: "my-app:${{ github.sha }}"

jobs:
  security:
    runs-on: ubuntu-22.04
    
    permissions:
      security-events: write
      actions: read
      contents: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.7
        
      - name: Install Trivy CLI
        run: |
          wget https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar -xzf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/
          
      - name: Build Docker image
        run: |
          docker build -t $DOCKER_IMAGE .
          
      - name: Scan Docker image with Trivy
        run: |
          trivy image \
            --format sarif \
            --output trivy-image.sarif \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            --ignore-unfixed \
            $DOCKER_IMAGE
            
      - name: Scan filesystem for misconfigurations
        run: |
          trivy config \
            --format sarif \
            --output trivy-config.sarif \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            .
            
      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3.2.0
        with:
          sarif_file: |
            trivy-image.sarif
            trivy-config.sarif